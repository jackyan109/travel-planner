<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Planner</title>

    <!-- âœ… Leaflet åœ°åœ– CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-image: url("https://d1grca2t3zpuug.cloudfront.net/2025/06/f32837568_m-870x500-1750991180.webp");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(10px);
            min-height: 100vh;
            padding-bottom: 80px;
            position: relative;
        }

        .top-banner {
            position: sticky;
            top: 0;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            padding: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }

        /* âœ… åŒ¯ç‡æ¨™ç±¤ï¼ˆå³ä¸Šè§’ï¼‰ */
        .rate-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #0078ff;
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 99999;
            cursor: pointer;
        }

        .countdown-card {
            background: white;
            margin: 10px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-align: center;
        }

        .countdown-title {
            font-size: 18px;
            font-weight: bold;
        }

        .countdown-time {
            font-size: 22px;
            margin-top: 8px;
            font-weight: bold;
            color: #0078ff;
        }

        .countdown-route {
            margin-top: 5px;
            font-size: 14px;
            color: #444;
        }

        .container {
            padding: 15px;
        }

        section {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        h2 {
            margin-top: 0;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background: #0078ff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #005fcc;
        }

        #map {
            width: 100%;
            height: 350px;
            border-radius: 10px;
        }

        .date-group {
            margin-bottom: 12px;
        }

        .date-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .itinerary-item {
            margin-bottom: 6px;
            padding: 8px;
            background: #f7f7f7;
            border-radius: 6px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-btn {
            color: red;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .budget-col {
            width: 30%;
            font-size: 14px;
        }

        .budget-delete {
            font-size: 18px;
            color: red;
            cursor: pointer;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 480px;
            max-width: 100%;
            background: white;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: space-around;
            padding: 6px 0;
            z-index: 9999;
        }

        .nav-btn {
            text-align: center;
            font-size: 13px;
            color: #555;
            cursor: pointer;
        }

        .nav-btn.active {
            color: #0078ff;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
<div class="app-container">

    <!-- âœ… ä¿®æ­£ç‰ˆ top-bannerï¼ˆåŒ¯ç‡åœ¨å³ä¸Šè§’ï¼‰ -->
    <div class="top-banner">
        ğŸ‡¯ğŸ‡µ æ±äº¬2025-2026
        <span id="rate-badge" class="rate-badge">æ›´æ–°ä¸­...</span>
    </div>

    <!-- âœ… å€’æ•¸è¨ˆæ™‚ -->
    <div class="countdown-card">
        <div class="countdown-title">âœˆï¸ å‡ºç™¼å€’æ•¸</div>
        <div id="countdown" class="countdown-time">è¨ˆç®—ä¸­...</div>
        <div class="countdown-route">HKG â†’ HND</div>
    </div>

    <div class="container">

        <!-- âœ… è¡Œç¨‹ -->
        <section id="itinerary-section">
            <h2>è¡Œç¨‹ Itinerary</h2>
            <input type="date" id="itinerary-date">
            <input type="text" id="itinerary-place" placeholder="åœ°é»">
            <button id="add-itinerary">æ–°å¢è¡Œç¨‹</button>
            <div id="itinerary-list"></div>
        </section>

        <!-- âœ… åœ°åœ– -->
        <section id="map-section" class="hidden">
            <h2>åœ°åœ– Map</h2>
            <label>ğŸ“… é¸æ“‡æ—¥æœŸï¼š</label>
            <select id="map-date-selector"></select>
            <div id="map"></div>
        </section>

        <!-- âœ… é ç®— -->
        <section id="budget-section" class="hidden">
            <h2>é ç®— Budget</h2>

            <input type="date" id="budget-date">
            <input type="text" id="budget-item" placeholder="é …ç›®">
            <input type="number" id="budget-amount" placeholder="é‡‘é¡ï¼ˆJPYï¼‰">

            <button id="add-budget">æ–°å¢é ç®—</button>

            <div id="budget-list"></div>

            <h3>ç¸½çµ</h3>
            <p id="budget-total-jpy">ç¸½æ—¥å…ƒï¼šÂ¥0</p>
            <p id="budget-total-hkd">æŠ˜åˆæ¸¯å…ƒï¼šHK$0.00</p>
        </section>

        <!-- âœ… è³¼ç‰© -->
        <section id="shopping-section" class="hidden">
            <h2>è³¼ç‰©æ¸…å–® Shopping List</h2>
            <input type="text" id="shopping-item" placeholder="ç‰©å“åç¨±">
            <input type="file" id="shopping-image">
            <button id="add-shopping">æ–°å¢ç‰©å“</button>
            <ul id="shopping-list"></ul>
        </section>

    </div>
</div>

<!-- âœ… åº•éƒ¨å°èˆª -->
<div class="bottom-nav">
    <div class="nav-btn active" data-target="itinerary-section">ğŸ“… è¡Œç¨‹</div>
    <div class="nav-btn" data-target="map-section">ğŸ“Œ åœ°åœ–</div>
    <div class="nav-btn" data-target="budget-section">ğŸ’° é ç®—</div>
    <div class="nav-btn" data-target="shopping-section">ğŸ›ï¸ è³¼ç‰©</div>
</div>

<!-- âœ… Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* âœ… åŒ¯ç‡æ›´æ–°ï¼ˆç©©å®š API + æœ€å¾Œæ›´æ–°æ™‚é–“ + é»æ“Šåˆ·æ–°ï¼‰ */
async function updateRate(showAnimation = true) {
    const badge = document.getElementById("rate-badge");

    try {
        badge.textContent = "æ›´æ–°ä¸­â€¦";

        // âœ… æ”¹ç”¨ç©©å®š APIï¼ˆopen.er-api.comï¼‰
        const res = await fetch("https://open.er-api.com/v6/latest/JPY");
        const data = await res.json();

        const rate = data.rates.HKD;
        window.currentRate = rate;

        // âœ… æ™‚é–“
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");

        badge.textContent = `[ Â¥1 = HK$${rate.toFixed(4)} | æ›´æ–° ${hh}:${mm} ]`;

        // âœ… å‹•ç•«æ•ˆæœ
        if (showAnimation) {
            badge.style.transition = "background 0.3s";
            badge.style.background = "#005fcc";
            setTimeout(() => {
                badge.style.background = "#0078ff";
            }, 300);
        }

        updateBudgetTotals();
    } catch (err) {
        console.error(err);
        badge.textContent = "[åŒ¯ç‡æ›´æ–°å¤±æ•—]";
    }
}

/* âœ… é»ä¸€ä¸‹åŒ¯ç‡ â†’ æ‰‹å‹•åˆ·æ–° */
document.addEventListener("DOMContentLoaded", () => {
    const badge = document.getElementById("rate-badge");
    badge.style.cursor = "pointer";

    badge.addEventListener("click", () => {
        updateRate(true);
    });
});

/* âœ… å€’æ•¸è¨ˆæ™‚ */
function initCountdown() {
    const countdownEl = document.getElementById("countdown");

    const departure = new Date(2025, 11, 25, 23, 55);
    const arrival = new Date(2025, 11, 26, 4, 45);

    function update() {
        const now = new Date();

        if (now < departure) {
            const diff = departure - now;
            const sec = Math.floor(diff / 1000);
            const days = Math.floor(sec / 86400);
            const hours = Math.floor((sec % 86400) / 3600);
            const mins = Math.floor((sec % 3600) / 60);
            const s = sec % 60;

            countdownEl.textContent =
                `${days} å¤© ${hours} å°æ™‚ ${mins} åˆ† ${s} ç§’`;
        } else if (now >= departure && now < arrival) {
            countdownEl.textContent = "å·²å‡ºç™¼ï¼Œå‰å¾€æ±äº¬ä¸­â€¦";
        } else {
            countdownEl.textContent = "å·²æŠµé”æ±äº¬ HND";
        }
    }

    update();
    setInterval(update, 1000);
}

/* âœ… è¡Œç¨‹è³‡æ–™ */
function loadItinerary() {
    return JSON.parse(localStorage.getItem("itinerary") || "{}");
}

function saveItinerary(data) {
    localStorage.setItem("itinerary", JSON.stringify(data));
}

/* âœ… è¡Œç¨‹æ¸²æŸ“ */
function renderItinerary() {
    const data = loadItinerary();
    const container = document.getElementById("itinerary-list");
    container.innerHTML = "";

    const dates = Object.keys(data).sort((a, b) => {
        const [da, ma, ya] = a.split("-");
        const [db, mb, yb] = b.split("-");
        return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
    });

    dates.forEach(date => {
        const group = document.createElement("div");
        group.className = "date-group";

        const title = document.createElement("div");
        title.className = "date-title";
        title.textContent = date;
        group.appendChild(title);

        data[date].forEach((place, index) => {
            const item = document.createElement("div");
            item.className = "itinerary-item";
            item.draggable = true;

            const text = document.createElement("span");
            text.textContent = place;

            const del = document.createElement("span");
            del.className = "delete-btn";
            del.textContent = "ğŸ—‘ï¸";
            del.onclick = () => {
                data[date].splice(index, 1);
                if (data[date].length === 0) delete data[date];
                saveItinerary(data);
                renderItinerary();
                updateMapDateSelector();
            };

            item.appendChild(text);
            item.appendChild(del);
            group.appendChild(item);
        });

        container.appendChild(group);
    });

    enableDrag();
}

/* âœ… è¡Œç¨‹æ‹–æ›³æ’åº */
function enableDrag() {
    const items = document.querySelectorAll(".itinerary-item");

    let dragged = null;

    items.forEach(item => {
        item.addEventListener("dragstart", () => {
            dragged = item;
            item.style.opacity = "0.5";
        });

        item.addEventListener("dragend", () => {
            dragged.style.opacity = "1";
            dragged = null;
        });

        item.addEventListener("dragover", e => e.preventDefault());

        item.addEventListener("drop", () => {
            if (dragged && dragged !== item) {
                const parent = item.parentNode;
                parent.insertBefore(dragged, item);

                saveNewOrder(parent);
            }
        });
    });
}

function saveNewOrder(parent) {
    const date = parent.previousSibling.textContent;
    const items = parent.querySelectorAll(".itinerary-item");

    const newList = [];
    items.forEach(i => newList.push(i.firstChild.textContent));

    const data = loadItinerary();
    data[date] = newList;
    saveItinerary(data);

    updateMapDateSelector();
}

/* âœ… æ–°å¢è¡Œç¨‹ */
document.getElementById("add-itinerary").onclick = () => {
    const dateInput = document.getElementById("itinerary-date").value;
    const place = document.getElementById("itinerary-place").value.trim();

    if (!dateInput || !place) return;

    const d = new Date(dateInput);
    const date = `${String(d.getDate()).padStart(2, "0")}-${String(d.getMonth() + 1).padStart(2, "0")}-${d.getFullYear()}`;

    const data = loadItinerary();
    if (!data[date]) data[date] = [];
    data[date].push(place);

    saveItinerary(data);
    renderItinerary();
    updateMapDateSelector();

    document.getElementById("itinerary-place").value = "";
};

/* âœ… Leaflet åœ°åœ–åˆå§‹åŒ– */
let map = L.map("map").setView([35.6804, 139.7690], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let markers = [];

/* âœ… âœ… âœ… è¶…é«˜é€Ÿç‰ˆ updateMapï¼ˆå«å¿«å–ï¼‰ */
async function updateMap(date) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const data = loadItinerary();
    if (!data[date]) return;

    // âœ… è®€å–å¿«å–
    let cache = JSON.parse(localStorage.getItem("geoCache") || "{}");

    for (const place of data[date]) {
        // âœ… å¦‚æœå¿«å–å·²æœ‰ â†’ ç›´æ¥ç”¨
        if (cache[place]) {
            const { lat, lon } = cache[place];
            const marker = L.marker([lat, lon]).addTo(map);
            marker.bindPopup(place);
            markers.push(marker);
            continue;
        }

        // âœ… æ²’æœ‰å¿«å– â†’ å‘¼å« Nominatim
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
        const res = await fetch(url);
        const json = await res.json();

        if (json.length > 0) {
            const lat = parseFloat(json[0].lat);
            const lon = parseFloat(json[0].lon);

            // âœ… å­˜å…¥å¿«å–
            cache[place] = { lat, lon };
            localStorage.setItem("geoCache", JSON.stringify(cache));

            const marker = L.marker([lat, lon]).addAddTo(map);
            marker.bindPopup(place);
            markers.push(marker);
        }
    }

    // âœ… è‡ªå‹•ç¸®æ”¾åˆ°æ‰€æœ‰æ¨™è¨˜
    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds(), { padding: [30, 30] });
    }
}

/* âœ… æ—¥æœŸé¸æ“‡å™¨æ›´æ–° */
function updateMapDateSelector() {
    const data = loadItinerary();
    const selector = document.getElementById("map-date-selector");
    selector.innerHTML = "";

    const dates = Object.keys(data).sort((a, b) => {
        const [da, ma, ya] = a.split("-");
        const [db, mb, yb] = b.split("-");
        return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
    });

    dates.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        selector.appendChild(opt);
    });

    if (dates.length > 0) {
        selector.value = dates[0];
        updateMap(dates[0]);
    }
}

document.getElementById("map-date-selector").onchange = e => {
    updateMap(e.target.value);
};

/* âœ… é ç®—è³‡æ–™ */
function loadBudget() {
    return JSON.parse(localStorage.getItem("budget") || "[]");
}

function saveBudget(data) {
    localStorage.setItem("budget", JSON.stringify(data));
}

/* âœ… æ–°å¢é ç®— */
document.getElementById("add-budget").onclick = () => {
    const date = document.getElementById("budget-date").value;
    const item = document.getElementById("budget-item").value.trim();
    const amount = Number(document.getElementById("budget-amount").value);

    if (!date || !item || !amount) return;

    const d = new Date(date);
    const dateStr = `${String(d.getDate()).padStart(2, "0")}-${String(d.getMonth() + 1).padStart(2, "0")}-${d.getFullYear()}`;

    const data = loadBudget();
    data.push({ date: dateStr, item, amount });
    saveBudget(data);

    renderBudget();
};

/* âœ… é ç®—æ¸²æŸ“ */
function renderBudget() {
    const data = loadBudget();
    const list = document.getElementById("budget-list");
    list.innerHTML = "";

    data.forEach((row, index) => {
        const div = document.createElement("div");
        div.className = "budget-row";

        const col1 = document.createElement("div");
        col1.className = "budget-col";
        col1.textContent = row.date;

        const col2 = document.createElement("div");
        col2.className = "budget-col";
        col2.textContent = row.item;

        const col3 = document.createElement("div");
        col3.className = "budget-col";
        col3.textContent = `Â¥${row.amount.toLocaleString()}`;

        const del = document.createElement("span");
        del.className = "budget-delete";
        del.textContent = "ğŸ—‘ï¸";
        del.onclick = () => {
            data.splice(index, 1);
            saveBudget(data);
            renderBudget();
        };

        div.appendChild(col1);
        div.appendChild(col2);
        div.appendChild(col3);
        div.appendChild(del);

        list.appendChild(div);
    });

    updateBudgetTotals();
}

/* âœ… é ç®—ç¸½é¡ */
function updateBudgetTotals() {
    const data = loadBudget();
    const totalJPY = data.reduce((sum, row) => sum + row.amount, 0);

    document.getElementById("budget-total-jpy").textContent =
        `ç¸½æ—¥å…ƒï¼šÂ¥${totalJPY.toLocaleString()}`;

    const rate = window.currentRate || 0.05;
    const hkd = totalJPY * rate;

    document.getElementById("budget-total-hkd").textContent =
        `æŠ˜åˆæ¸¯å…ƒï¼šHK$${hkd.toFixed(2)}`;
}

/* âœ… åº•éƒ¨å°èˆª */
function initBottomNav() {
    const navBtns = document.querySelectorAll(".nav-btn");
    const sections = {
        "itinerary-section": document.getElementById("itinerary-section"),
        "map-section": document.getElementById("map-section"),
        "budget-section": document.getElementById("budget-section"),
        "shopping-section": document.getElementById("shopping-section")
    };

    function showSection(id) {
        Object.keys(sections).forEach(key => {
            sections[key].classList.toggle("hidden", key !== id);
        });
    }

    showSection("itinerary-section");

    navBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            navBtns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            const target = btn.dataset.target;
            showSection(target);
            window.scrollTo({ top: 0, behavior: "smooth" });
        });
    });
}

/* âœ… è³¼ç‰©æ¸…å–® */
document.getElementById("add-shopping").onclick = () => {
    const item = document.getElementById("shopping-item").value.trim();
    const imgFile = document.getElementById("shopping-image").files[0];

    if (!item) return;

    const li = document.createElement("li");
    li.textContent = item;

    if (imgFile) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(imgFile);
        img.style.maxWidth = "100px";
        img.style.display = "block";
        img.style.marginTop = "5px";
        li.appendChild(img);
    }

    document.getElementById("shopping-list").appendChild(li);

    document.getElementById("shopping-item").value = "";
    document.getElementById("shopping-image").value = "";
};

/* âœ… åˆå§‹åŒ– */
document.addEventListener("DOMContentLoaded", () => {
    updateRate(false); // ç¬¬ä¸€æ¬¡è¼‰å…¥ä¸éœ€è¦å‹•ç•«
    initCountdown();
    initBottomNav();
    renderItinerary();
    updateMapDateSelector();
    renderBudget();
});
</script>

</body>
</html>
